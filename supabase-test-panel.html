<!DOCTYPE html>
<html lang="es">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <title>Panel de Verificaci√≥n Supabase</title>
  <script src="https://unpkg.com/@supabase/supabase-js@2.39.3/dist/umd/supabase.js"></script>
  <style>
    body {
      font-family: 'Segoe UI', Tahoma, Geneva, Verdana, sans-serif;
      max-width: 800px;
      margin: 0 auto;
      padding: 20px;
      background-color: #f5f5f5;
    }
    .container {
      background: white;
      border-radius: 10px;
      padding: 30px;
      box-shadow: 0 2px 10px rgba(0,0,0,0.1);
    }
    h1 {
      color: #333;
      text-align: center;
      margin-bottom: 30px;
    }
    .test-section {
      margin: 20px 0;
      padding: 15px;
      border: 1px solid #ddd;
      border-radius: 5px;
      background: #f9f9f9;
    }
    .test-button {
      background: #3b82f6;
      color: white;
      border: none;
      padding: 10px 20px;
      border-radius: 5px;
      cursor: pointer;
      margin: 5px;
    }
    .test-button:hover {
      background: #2563eb;
    }
    .test-button:disabled {
      background: #9ca3af;
      cursor: not-allowed;
    }
    .result {
      margin-top: 10px;
      padding: 10px;
      border-radius: 5px;
      white-space: pre-wrap;
      font-family: monospace;
      font-size: 12px;
    }
    .success {
      background: #d1fae5;
      border: 1px solid #10b981;
      color: #065f46;
    }
    .error {
      background: #fee2e2;
      border: 1px solid #ef4444;
      color: #991b1b;
    }
    .info {
      background: #dbeafe;
      border: 1px solid #3b82f6;
      color: #1e40af;
    }
    .status {
      display: inline-block;
      padding: 4px 8px;
      border-radius: 4px;
      font-size: 12px;
      font-weight: bold;
    }
    .status.success { background: #10b981; color: white; }
    .status.error { background: #ef4444; color: white; }
    .status.warning { background: #f59e0b; color: white; }
  </style>
</head>
<body>
  <div class="container">
    <h1>üîå Panel de Verificaci√≥n Supabase</h1>
    
    <div class="test-section">
      <h3>üìã Informaci√≥n de Configuraci√≥n</h3>
      <div id="config-info"></div>
    </div>

    <div class="test-section">
      <h3>üîó Test 1: Conexi√≥n B√°sica</h3>
      <button class="test-button" onclick="testBasicConnection()">Probar Conexi√≥n</button>
      <div id="connection-result" class="result"></div>
    </div>

    <div class="test-section">
      <h3>üìä Test 2: Lectura de Tabla Reports</h3>
      <button class="test-button" onclick="testReadReports()">Leer Reportes</button>
      <div id="read-result" class="result"></div>
    </div>

    <div class="test-section">
      <h3>‚ûï Test 3: Inserci√≥n de Prueba</h3>
      <button class="test-button" onclick="testInsertReport()">Insertar Reporte de Prueba</button>
      <div id="insert-result" class="result"></div>
    </div>

    <div class="test-section">
      <h3>üóëÔ∏è Test 4: Eliminaci√≥n de Prueba</h3>
      <button class="test-button" onclick="testDeleteReport()">Eliminar Reportes de Prueba</button>
      <div id="delete-result" class="result"></div>
    </div>

    <div class="test-section">
      <h3>üöÄ Test 5: Test Completo de Aplicaci√≥n</h3>
      <button class="test-button" onclick="testFullWorkflow()">Ejecutar Test Completo</button>
      <div id="full-result" class="result"></div>
    </div>

    <div class="test-section">
      <h3>üîÑ Acciones</h3>
      <button class="test-button" onclick="clearResults()">Limpiar Resultados</button>
      <button class="test-button" onclick="runAllTests()">Ejecutar Todos los Tests</button>
    </div>
  </div>

  <script>
    // Configuraci√≥n de Supabase con tus credenciales exactas
    const SUPABASE_URL = 'https://jyhgslhndkwmawzkawni.supabase.co';
    const SUPABASE_ANON_KEY = 'eyJhbGciOiJIUzI1NiIsInR5cCI6IkpXVCJ9.eyJpc3MiOiJzdXBhYmFzZSIsInJlZiI6Imp5aGdzbGhuZGt3bWF3emthd25pIiwicm9sZSI6ImFub24iLCJpYXQiOjE3NTU1MTEwNTUsImV4cCI6MjA3MTA4NzA1NX0.19RtsJxGGrSzLiD8GL0jwHpd-vj8rNhLEx03eG5AcLQ';

    let supabaseClient;

    // Inicializar al cargar la p√°gina
    window.onload = function() {
      showConfigInfo();
      initializeSupabase();
    };

    function showConfigInfo() {
      const configDiv = document.getElementById('config-info');
      configDiv.innerHTML = `
        <div class="info">
          <strong>URL:</strong> ${SUPABASE_URL}<br>
          <strong>API Key:</strong> ${SUPABASE_ANON_KEY.substring(0, 20)}...${SUPABASE_ANON_KEY.substring(SUPABASE_ANON_KEY.length - 10)}<br>
          <strong>Biblioteca Supabase:</strong> <span class="status ${window.supabase ? 'success' : 'error'}">${window.supabase ? 'CARGADA' : 'NO DISPONIBLE'}</span><br>
          <strong>Funci√≥n createClient:</strong> <span class="status ${window.supabase?.createClient ? 'success' : 'error'}">${window.supabase?.createClient ? 'DISPONIBLE' : 'NO DISPONIBLE'}</span>
        </div>
      `;
    }

    function initializeSupabase() {
      try {
        if (!window.supabase) {
          throw new Error('Biblioteca Supabase no cargada');
        }
        
        supabaseClient = window.supabase.createClient(SUPABASE_URL, SUPABASE_ANON_KEY);
        console.log('Cliente Supabase inicializado:', supabaseClient);
        
        updateResult('config-info', 'info', 'Cliente Supabase inicializado correctamente ‚úÖ');
      } catch (error) {
        console.error('Error inicializando Supabase:', error);
        updateResult('config-info', 'error', `Error: ${error.message}`);
      }
    }

    async function testBasicConnection() {
      const resultDiv = document.getElementById('connection-result');
      resultDiv.innerHTML = '<div class="info">Probando conexi√≥n...</div>';
      
      try {
        // Test b√°sico de conexi√≥n
        const { data, error } = await supabaseClient
          .from('reports')
          .select('count', { count: 'exact', head: true });

        if (error) {
          throw error;
        }

        updateResult('connection-result', 'success', 
          `‚úÖ Conexi√≥n exitosa!\nConteo de registros: ${data}\nEstado: CONECTADO`);
      } catch (error) {
        updateResult('connection-result', 'error', 
          `‚ùå Error de conexi√≥n:\n${JSON.stringify(error, null, 2)}`);
      }
    }

    async function testReadReports() {
      const resultDiv = document.getElementById('read-result');
      resultDiv.innerHTML = '<div class="info">Leyendo reportes...</div>';
      
      try {
        const { data, error } = await supabaseClient
          .from('reports')
          .select('*')
          .order('created_at', { ascending: false })
          .limit(5);

        if (error) {
          throw error;
        }

        updateResult('read-result', 'success', 
          `‚úÖ Lectura exitosa!\nReportes encontrados: ${data.length}\nDatos:\n${JSON.stringify(data, null, 2)}`);
      } catch (error) {
        updateResult('read-result', 'error', 
          `‚ùå Error leyendo reportes:\n${JSON.stringify(error, null, 2)}`);
      }
    }

    async function testInsertReport() {
      const resultDiv = document.getElementById('insert-result');
      resultDiv.innerHTML = '<div class="info">Insertando reporte de prueba...</div>';
      
      try {
        const testReport = {
          name: `TEST - Verificaci√≥n ${new Date().toLocaleString()}`,
          date: new Date().toISOString(),
          filename: `test-report-${Date.now()}.csv`,
          headers: JSON.stringify(['Col1', 'Col2', 'Col3']),
          data: JSON.stringify([['Test1', 'Test2', 'Test3'], ['Data1', 'Data2', 'Data3']]),
          recordcount: 2
        };

        const { data, error } = await supabaseClient
          .from('reports')
          .insert([testReport])
          .select();

        if (error) {
          throw error;
        }

        updateResult('insert-result', 'success', 
          `‚úÖ Inserci√≥n exitosa!\nReporte creado con ID: ${data[0].id}\nDatos:\n${JSON.stringify(data[0], null, 2)}`);
      } catch (error) {
        updateResult('insert-result', 'error', 
          `‚ùå Error insertando reporte:\n${JSON.stringify(error, null, 2)}`);
      }
    }

    async function testDeleteReport() {
      const resultDiv = document.getElementById('delete-result');
      resultDiv.innerHTML = '<div class="info">Eliminando reportes de prueba...</div>';
      
      try {
        const { data, error } = await supabaseClient
          .from('reports')
          .delete()
          .like('name', 'TEST -%')
          .select();

        if (error) {
          throw error;
        }

        updateResult('delete-result', 'success', 
          `‚úÖ Eliminaci√≥n exitosa!\nReportes eliminados: ${data.length}\nIDs eliminados: ${data.map(r => r.id).join(', ')}`);
      } catch (error) {
        updateResult('delete-result', 'error', 
          `‚ùå Error eliminando reportes:\n${JSON.stringify(error, null, 2)}`);
      }
    }

    async function testFullWorkflow() {
      const resultDiv = document.getElementById('full-result');
      resultDiv.innerHTML = '<div class="info">Ejecutando workflow completo...</div>';
      
      try {
        let results = [];
        
        // 1. Verificar conexi√≥n
        results.push('1. Verificando conexi√≥n...');
        const { data: countData, error: countError } = await supabaseClient
          .from('reports')
          .select('count', { count: 'exact', head: true });
        if (countError) throw new Error(`Conexi√≥n: ${countError.message}`);
        results.push(`   ‚úÖ Conectado. Registros actuales: ${countData}`);

        // 2. Insertar reporte de prueba
        results.push('2. Insertando reporte...');
        const testReport = {
          name: `WORKFLOW-TEST - ${new Date().toLocaleString()}`,
          date: new Date().toISOString(),
          filename: `workflow-test-${Date.now()}.csv`,
          headers: JSON.stringify(['Requisition #', 'Status', 'Net total']),
          data: JSON.stringify([['REQ001', 'More information needed', '1000'], ['REQ002', 'To be approved', '2000']]),
          recordcount: 2
        };
        
        const { data: insertData, error: insertError } = await supabaseClient
          .from('reports')
          .insert([testReport])
          .select();
        if (insertError) throw new Error(`Inserci√≥n: ${insertError.message}`);
        results.push(`   ‚úÖ Reporte insertado con ID: ${insertData[0].id}`);

        // 3. Leer reporte
        results.push('3. Verificando lectura...');
        const { data: readData, error: readError } = await supabaseClient
          .from('reports')
          .select('*')
          .eq('id', insertData[0].id);
        if (readError) throw new Error(`Lectura: ${readError.message}`);
        results.push(`   ‚úÖ Reporte le√≠do correctamente: ${readData[0].name}`);

        // 4. Limpiar
        results.push('4. Limpiando datos de prueba...');
        const { error: deleteError } = await supabaseClient
          .from('reports')
          .delete()
          .eq('id', insertData[0].id);
        if (deleteError) throw new Error(`Eliminaci√≥n: ${deleteError.message}`);
        results.push(`   ‚úÖ Datos de prueba eliminados`);

        results.push('\nüéâ WORKFLOW COMPLETO EXITOSO!');
        results.push('Tu aplicaci√≥n deber√≠a funcionar perfectamente.');

        updateResult('full-result', 'success', results.join('\n'));
      } catch (error) {
        updateResult('full-result', 'error', 
          `‚ùå Error en workflow:\n${error.message}\n\nStack:\n${error.stack}`);
      }
    }

    async function runAllTests() {
      console.log('Ejecutando todos los tests...');
      await testBasicConnection();
      await sleep(1000);
      await testReadReports();
      await sleep(1000);
      await testInsertReport();
      await sleep(1000);
      await testDeleteReport();
      await sleep(1000);
      await testFullWorkflow();
    }

    function clearResults() {
      const results = document.querySelectorAll('.result');
      results.forEach(result => {
        if (result.id !== 'config-info') {
          result.innerHTML = '';
        }
      });
    }

    function updateResult(elementId, type, message) {
      const element = document.getElementById(elementId);
      if (elementId === 'config-info') {
        element.innerHTML += `<div class="${type}">${message}</div>`;
      } else {
        element.innerHTML = `<div class="${type}">${message}</div>`;
      }
    }

    function sleep(ms) {
      return new Promise(resolve => setTimeout(resolve, ms));
    }
  </script>
</body>
</html>
