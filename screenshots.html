<!DOCTYPE html>
<html lang="es">
<head>
  <meta charset="UTF-8">
  <title>Capturas de Requisición</title>
  <link rel="stylesheet" href="style.css">
  <style>
    body { font-family: 'Inter', sans-serif; background: #f3f4f6; margin: 0; }
    .container { max-width: 900px; margin: 40px auto; background: #fff; border-radius: 12px; box-shadow: 0 4px 24px #0001; padding: 32px; }
    h2 { color: #1565c0; margin-bottom: 24px; }
    .images-grid { display: flex; flex-wrap: wrap; gap: 24px; }
    .img-card { background: #f1f5f9; border-radius: 8px; box-shadow: 0 2px 8px #0002; padding: 16px; text-align: center; }
    .img-card img { width: 220px; height: 140px; object-fit: cover; border-radius: 8px; cursor: pointer; }
    .img-card .date { margin: 8px 0; color: #64748b; font-size: 14px; }
    .img-card button { background: #ef4444; color: white; border: none; padding: 6px 16px; border-radius: 6px; cursor: pointer; font-size: 14px; }
    .add-btn { background: #0ea5e9; color: white; padding: 10px 24px; border: none; border-radius: 8px; cursor: pointer; font-size: 16px; margin-bottom: 24px; }
    #uploadStatus { margin-left: 15px; color: #0369a1; font-size: 14px; }
  </style>
</head>
<body>
  <div class="container">
    <h2 id="title">Capturas</h2>
    <button class="add-btn" onclick="document.getElementById('figuresFileInput').click()">Añadir imagen</button>
    <input type="file" id="figuresFileInput" accept="image/*" multiple style="display:none;">
    <span id="uploadStatus"></span>
    <div class="images-grid" id="imagesGrid"></div>
  </div>
  <script src="script.js"></script>
  <script>
    // Obtener el id de la requisición desde la URL
    const params = new URLSearchParams(window.location.search);
    const requisitionId = params.get('id');
    document.getElementById('title').textContent = `Capturas de ${requisitionId}`;
    async function renderGrid() {
      const grid = document.getElementById('imagesGrid');
      const screenshots = await window.getScreenshots(requisitionId);
      grid.innerHTML = screenshots.length > 0 ? screenshots.map(s => `
        <div class='img-card'>
          <img src='${s.imageData}' onclick='window.openImageFullscreen("${s.imageData}")'>
          <div class='date'>${s.uploadDate}</div>
          <button onclick='deleteScreenshot(${s.id})'>Eliminar</button>
        </div>
      `).join('') : `<div style='padding:40px;text-align:center;color:#64748b;'>No hay capturas</div>`;
    }
    async function deleteScreenshot(id) {
      if (confirm('¿Eliminar esta captura?')) {
        await window.deleteScreenshot(id);
        await renderGrid();
      }
    }
    document.getElementById('figuresFileInput').onchange = async function(e) {
      const files = Array.from(e.target.files);
      let ok = 0, fail = 0, errorMsg = '';
      document.getElementById('uploadStatus').textContent = 'Procesando...';
      // Esperar a que la base de datos esté lista
      if (!window.db) {
        try {
          await window.initDB?.();
        } catch (err) {
          document.getElementById('uploadStatus').textContent = 'Error inicializando la base de datos.';
          return;
        }
      }
      for (const file of files) {
        if (!file.type.startsWith('image/')) {
          fail++;
          errorMsg += `Archivo no válido: ${file.name}. `;
          continue;
        }
        try {
          await window.saveScreenshot(requisitionId, file, file.name);
          // Descargar automáticamente en figures
          const url = URL.createObjectURL(file);
          const link = document.createElement('a');
          link.href = url;
          link.download = `figures/${requisitionId}_${file.name}`;
          document.body.appendChild(link);
          link.click();
          document.body.removeChild(link);
          URL.revokeObjectURL(url);
          ok++;
        } catch (err) {
          fail++;
          errorMsg += `Error al guardar ${file.name}: ${err.message}. `;
        }
      }
      let msg = `${ok} imagen${ok!==1?'es':''} añadida${ok!==1?'s':''}`;
      if (fail > 0) msg += `, ${fail} error${fail!==1?'es':''}`;
      if (errorMsg) msg += `. ${errorMsg}`;
      document.getElementById('uploadStatus').textContent = msg;
      setTimeout(()=>{document.getElementById('uploadStatus').textContent='';},4000);
      await renderGrid();
    };
    renderGrid();
  </script>
</body>
</html>
